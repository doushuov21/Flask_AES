<!DOCTYPE html>
<html>
<head>
    <title>API Key 管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .toast-container {
            position: fixed;
            z-index: 1050;
            pointer-events: none; /* 允许点击穿透 */
            transition: all 0.3s ease; /* 平滑移动效果 */
        }
        .toast {
            pointer-events: auto; /* 恢复 toast 的点击事件 */
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- Toast 容器 -->
    <div class="toast-container"></div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('admin.dashboard') }}">返回管理面板</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col">
                <h2>API Key 管理</h2>
                <button class="btn btn-primary" onclick="createApiKey()">
                    创建新的 API Key
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <table class="table">
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>API Key</th>
                            <th>创建时间</th>
                            <th>最后使用</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in keys %}
                        <tr>
                            <td>{{ key.name }}</td>
                            <td>
                                <div class="input-group">
                                    <input type="text" class="form-control" 
                                           value="{{ key.key }}" 
                                           id="key-{{ key.id }}" readonly>
                                    <button class="btn btn-outline-secondary" 
                                            onclick="copyKey('{{ key.key }}')">
                                        复制
                                    </button>
                                </div>
                            </td>
                            <td>{{ key.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>{{ key.last_used.strftime('%Y-%m-%d %H:%M:%S') if key.last_used else '从未使用' }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" 
                                        onclick="deleteKey({{ key.id }})">删除</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let mouseX = 0;
        let mouseY = 0;

        // 跟踪鼠标位置
        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        // 显示提示信息的函数
        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            
            // 计算 toast 的位置
            // 确保 toast 不会超出视窗
            const padding = 20;
            const maxX = window.innerWidth - 300 - padding; // 300px 是 toast 的大致宽度
            const maxY = window.innerHeight - 100 - padding; // 100px 是 toast 的大致高度
            
            const posX = Math.min(Math.max(mouseX - 150, padding), maxX); // 居中于鼠标
            const posY = Math.min(Math.max(mouseY - 50, padding), maxY);

            // 设置容器位置
            toastContainer.style.left = posX + 'px';
            toastContainer.style.top = posY + 'px';

            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toast = toastContainer.lastElementChild;
            const bsToast = new bootstrap.Toast(toast, { 
                autohide: true, 
                delay: 3000
            });
            
            // 添加动画效果
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            bsToast.show();
            
            // 监听隐藏事件
            toast.addEventListener('hidden.bs.toast', () => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300); // 等待淡出动画完成
            });
        }

        function createApiKey() {
            const name = prompt('请输入 API Key 名称：');
            if (!name) return;

            fetch('/admin/api-keys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: name }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'danger');
                } else {
                    showToast(`API Key 创建成功：${data.key}\n请保存此密钥，它不会再次显示。`);
                    setTimeout(() => location.reload(), 3000);
                }
            });
        }

        function deleteKey(keyId) {
            if (!confirm('确定要删除这个 API Key 吗？')) return;

            fetch(`/admin/api-keys/${keyId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'danger');
                } else {
                    showToast('API Key 已删除');
                    setTimeout(() => location.reload(), 3000);
                }
            });
        }

        function copyKey(key) {
            // 创建一个临时的 textarea 元素
            const textarea = document.createElement('textarea');
            textarea.value = key;
            document.body.appendChild(textarea);
            
            // 选择文本并复制
            textarea.select();
            document.execCommand('copy');
            
            // 移除临时元素
            document.body.removeChild(textarea);
            
            showToast('API Key 已复制！');
        }
    </script>
</body>
</html> 